/*! (C) 2021 Conviva, Inc. All rights reserved. Confidential and proprietary. */

!function(e,t){var i;"function"===typeof define&&define.amd?define(t):("object"===typeof exports||"object"===typeof module&&module.exports)&&(module.exports=t()),"undefined"!==typeof e&&e&&("undefined"!==typeof e.Conviva&&e.Conviva?e.Conviva.ProxyMonitor||e.ConvivaModuleLoading||(i=t(),e.ConvivaModuleLoading=!0,e.Conviva.ProxyMonitor=i.ProxyMonitor,e.Conviva.Impl.WebmafProxy=i.Impl.WebmafProxy,delete e.ConvivaModuleLoading):e.ConvivaModule||e.ConvivaModuleLoading||(e.ConvivaModuleLoading=!0,e.ConvivaModule=t(),delete e.ConvivaModuleLoading))}(this,function(){var r={};return function(){"use strict";!function(){function e(e,t,i,n){var a=this;function r(e){e&&e.playerState&&(a.e("WebmafProxy._onPlayerStateChange()"+e.playerState),(e=a.t(e.playerState))!==n.Constants.PlayerState.UNKNOWN&&a.i(e))}function o(e){e&&e.totalLength&&(a.e("WebmafProxy._onContentAvailable()"+e.totalLength),a.n(e.totalLength))}function s(e){var t;a.e("WebmafProxy._onPlayerStreamingError()"+e),e&&(e.error&&(t="Error["+e.error+"]"),e.status_code&&(e="ErrorStatusCode["+e.status_code+"]",t?t+=e:t=e)),a.r(t=!t?"player_streaming_error_unknown":t,!0)}function c(e){var t,i;if((a.e("WebmafProxy._onPlayerError()"+e),e)&&(e.error&&(t="Error["+e.error+"]"),e.error_code&&(i="ErrorCode["+e.error_code+"]",t?t+=i:t=i),e.error_info&&(i="ErrorInfo["+e.error_info+"]",t?t+=i:t=i),-2140536830===e.error_code&&e.error_info.indexOf("sceAvPlayerSetTrickSpeed")>0))return void a.r(t,!1);a.r(t=!t?"player_error_unknown":t,!0)}function u(e){var t;a.e("WebmafProxy._onNetworkStatusChange()"+e),e&&"ok"===e.status&&("disconnected"!==(t=e.newState).toLowerCase()&&"unknown"!==t.toLowerCase()||a.o===t?"connected"===e.newState.toLowerCase()&&a.o!==t?(a.o=e.connectionType,n.Analytics.reportDeviceMetric(n.Constants.Network.CONNECTION_TYPE,e.connectionType)):e.newState.toLowerCase():(a.o=t,n.Analytics.reportDeviceMetric(n.Constants.Network.CONNECTION_TYPE,t="unknown"===t?"error":t)))}function f(e){a.e("WebmafProxy._onApplicationStatusChange()"+e),e&&"ok"===e.status&&("background"===e.applicationStatus?n.Analytics.reportAppBackgrounded():"foreground"===e.applicationStatus&&n.Analytics.reportAppForegrounded())}this.a=null,this.s=-1,this.c=-1,this.u=-1,this.f=-1,this.d=n.Constants.PlayerState.UNKNOWN,this.h=0,this.v=-1,this.cleanup=function(){this.e("webmafProxy.cleanup()"),this.l(),this.m()},this.y=function(){a.e("WebmafProxy._registerVideoEventListeners()"),a.w("playerStatusChange",r),a.w("contentAvailable",o),a.w("playerStreamingError",s),a.w("playerError",c),a.w("networkStatusChange",u),a.w("applicationStatusChange",f),videometrics.onError=function(e,t){var i;e&&(i="Error["+e+"]"),t&&(i?i+="ErrorCode["+t+"]":i="ErrorCode["+t+"]"),a.r(i=!i?"error_unknown":i,!0)},videometrics.onBitrateChange=function(e){if(isFinite(e)&&e>0)try{var t;videometrics.url&&(t=Math.round(e/1e3),a.h!==t&&(a.h=t,a.p.reportPlaybackMetric(n.Constants.Playback.BITRATE,t,"CONVIVA")))}catch(e){a.e("Exception while reading videometrics.url: ",e)}}},this.m=function(){a.e("WebmafProxy._removeEventListener()"),a.g("playerStatusChange",r),a.g("contentAvailable",o),a.g("playerStreamingError",s),a.g("playerError",c),a.g("networkStatusChange",u),a.g("applicationStatusChange",f)},this.r=function(e,t){a.e("WebmafProxy._declareError: code "+e),a.p.reportPlaybackError(e,t?n.Constants.ErrorSeverity.FATAL:n.Constants.ErrorSeverity.WARNING)},this.S=function(e){e&&e.connectionType&&a.o!==e.connectionType&&(a.o=e.connectionType,n.Analytics.reportDeviceMetric(n.Constants.Network.CONNECTION_TYPE,e.connectionType))},this.t=function(e,t){if("string"!==typeof e)return n.Constants.PlayerState.UNKNOWN;if(t&&"playing"===e.toLowerCase())return n.Constants.PlayerState.PLAYING;switch(e.toLowerCase()){case"opening":case"buffering":return n.Constants.PlayerState.BUFFERING;case"displayingvideo":return n.Constants.PlayerState.PLAYING;case"paused":return n.Constants.PlayerState.PAUSED;case"stopped":case"endofstream":case"notready":case"unready":case"closed":case"ended":return n.Constants.PlayerState.STOPPED;default:return n.Constants.PlayerState.UNKNOWN}},this.i=function(e){a.d!==e&&(a.e("WebmafProxy._setPlayerState(): "+e),a.p.reportPlaybackMetric(n.Constants.Playback.PLAYER_STATE,e,"CONVIVA"),a.d=e)},this.n=function(e){a.e("WebmafProxy._setDuration()"),a.d===n.Constants.PlayerState.PLAYING&&isFinite(e)&&a.v!==e&&(a.v=e,e={},a.v>0?(e[n.Constants.DURATION]=a.v,e[n.Constants.IS_LIVE]=n.Constants.StreamType.VOD):0===a.v&&(e[n.Constants.IS_LIVE]=n.Constants.StreamType.LIVE),a.p.setContentInfo(e))},this.C=function(){this.b=this.a.createTimer(this._,1e3,"webmafProxy._poll()")},this._=function(){var e;a.p.getAdType()!==n.Constants.AdType.CLIENT_SIDE?videometrics&&(a.P===videometrics.naturalHeight&&a.W===videometrics.naturalWidth||(a.W=videometrics.naturalWidth,a.P=videometrics.naturalHeight,a.p.reportPlaybackMetric(n.Constants.Playback.RESOLUTION,videometrics.naturalWidth,videometrics.naturalHeight,"CONVIVA")),a.u!==videometrics.encodedFramerate&&(a.u=videometrics.encodedFramerate,(e={})[n.Constants.ENCODED_FRAMERATE]=a.u,a.p.setContentInfo(e)),a.f!==videometrics.renderedFramerate&&(a.f=videometrics.renderedFramerate,a.p.reportPlaybackMetric(n.Constants.Playback.RENDERED_FRAMERATE,videometrics.renderedFramerate,"CONVIVA")),a.p.reportPlaybackMetric(n.Constants.Playback.PLAY_HEAD_TIME,videometrics.elapsed,"CONVIVA"),a.n(videometrics.duration/1e3),a.x(),videometrics.poll()):a.d!==n.Constants.PlayerState.UNKNOWN&&(a.d=n.Constants.PlayerState.UNKNOWN)},this.x=function(){var e,t=videometrics.currentBitrate;if(isFinite(t)&&t>0)try{videometrics.url&&(e=Math.round(t/1e3),a.h!==e&&(a.h=e,a.p.reportPlaybackMetric(n.Constants.Playback.BITRATE,e,"CONVIVA")))}catch(e){a.e("Exception while reading videometrics.url: ",e)}},this.k=function(){a.e("videometrics.currentState "+videometrics.currentState);var e=a.t(videometrics.currentState);e!==n.Constants.PlayerState.UNKNOWN&&a.i(e)},this.l=function(){this.b&&this.b()},this.e=function(e){this.A.log(e,n.SystemSettings.LogLevel.DEBUG)},this.M=function(e,t,i){a.V||(a.V={});var n=a.V[e];n||(n=a.V[e]=[]),i&&n.push(i);var r={command:e};if(t)for(var o in t)r[o]=t[o];i=a.jsonEncode(r);"getPlaybackTime"!==e&&a.N("[nativeCommand] "+i),window.external&&window.external.user&&window.external.user(i)},this.w=function(e,t){a.V||(a.V={});var i=a.V[e];i?a.g(e,t):i=a.V[e]=[],i.push(t)},this.g=function(e,t){a.V||(a.V={});var i=a.V[e];if(i)for(var n=0;n<i.length;n++)if(i[n]===t)return void i.splice(n,1)},this.O=function(t){var i=null;try{i=a.jsonDecode(t)}catch(e){i=a.jsonDecode(t.replace("}","\"}"))}if(i){var e=i.command;"getPlaybackTime"!==e&&a.N("[WebmafProxy::nativeCallback] "+t),a.V||(a.V={});var n=a.V[e];if(n&&n.length>0)switch(e){case"networkStatusChange":case"contentAvailable":case"playerStatusChange":case"playerError":case"playerMessage":case"playerStreamingError":case"applicationStatusChange":for(var r=0;r<n.length;r++)n[r](i);break;default:n.shift(1)(i)}}},this.jsonEncode=function(e){return JSON.stringify(e)},this.jsonDecode=function(e){return JSON.parse(e)},this.N=function(e){var t=((new Date).getTime()/1e3).toFixed(3).toString();a.e(e="["+t+"] "+e)},this.I=function(e){a.F&&a.F(e),a.O(e)},this.D=function(){"function"===typeof window.accessfunction&&(a.F=window.accessfunction),window.accessfunction=a.I},this.J=function(){a.F?window.accessfunction=a.F:window.accessfunction=null},this.R=function(){a.M("getScreenResolution",{},function(e){a.T(e)})},this.T=function(e){var t={};t[n.Constants.DeviceMetadata.SCREEN_RESOLUTION_WIDTH]=e.width,t[n.Constants.DeviceMetadata.SCREEN_RESOLUTION_HEIGHT]=e.height,t[n.Constants.DeviceMetadata.SCREEN_RESOLUTION_SCALE_FACTOR]=1,n.Analytics.setDeviceMetadata(t)},function(e,t,i,n){this.p=i,this.A=t.buildLogger(),this.A.setModuleName("webmafProxy"),this.e("webmafProxy._constr()"),this.a=t.buildTimer(),this.j=t.buildTime(),(t={})[n.Constants.DeviceMetadata.TYPE]=n.Constants.DeviceType.CONSOLE,t[n.Constants.DeviceMetadata.CATEGORY]=n.Constants.DeviceCategory.PLAYSTATION,n.Analytics.setDeviceMetadata(t),(t={})[n.Constants.MODULE_NAME]="WebMAF",t[n.Constants.MODULE_VERSION]="4.0.5",this.p.setContentInfo(t),(t={})[n.Constants.FRAMEWORK_NAME]="WebMAF",WM_devSettings&&(WM_devSettings.version&&"string"===typeof WM_devSettings.version&&-1!==WM_devSettings.version.indexOf("-")?t[n.Constants.FRAMEWORK_VERSION]=WM_devSettings.version.slice(1,WM_devSettings.version.indexOf("-")):t[n.Constants.FRAMEWORK_VERSION]=WM_devSettings.version),this.p.setPlayerInfo(t),this.D(),this.y(),this.C(),this.k(),this.M("getDeviceInfo",{},function(e){a.S(e)}),this.R()}.apply(this,arguments)}r.ProxyMonitor={L:null,release:function(){this.L&&this.L.cleanup()},initConvivaDropIn:function(e,t,i,n){return this.L=new r.Impl.WebmafProxy(e,t,i,n),this.L}};e.version="4.0.2","undefined"!==typeof Conviva&&function(){function n(e){return JSON.parse(e)}var r;"function"===typeof window.accessfunction&&(r=window.accessfunction),window.accessfunction=function(t){var e,i=null;try{i=n(t)}catch(e){i=n(t.replace('}','"}'))}null!=i&&"getScreenResolution"===i.command&&((e={})[Conviva.Constants.DeviceMetadata.SCREEN_RESOLUTION_WIDTH]=i.width,e[Conviva.Constants.DeviceMetadata.SCREEN_RESOLUTION_HEIGHT]=i.height,e[Conviva.Constants.DeviceMetadata.SCREEN_RESOLUTION_SCALE_FACTOR]=1,Conviva.Analytics.setDeviceMetadata(e)),r&&r(t)};var e,t=(e={command:"getScreenResolution"},JSON.stringify(e));window.external&&window.external.user&&window.external.user(t)}(),"undefined"!==typeof r&&(r.Impl=r.Impl||{},r.Impl.WebmafProxy=e)}()}(),r});